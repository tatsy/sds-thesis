% pethesis.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{pethesis}[Jan. 20, 2020 by Takashi Michikawa, Yukie Nagai, and Tatsuya Yatagawa]

% ------------------------------------------------------------------------------
% スタイルファイルオプションの設定
% ------------------------------------------------------------------------------
\RequirePackage{iftex}
\RequirePackage{xkeyval}
\RequirePackage{ifthen}

\newcommand{\@jpfont}{}
\DeclareOptionX{jpfont}{\renewcommand{\@jpfont}{#1}}

\newif\if@autobreaksec
\@autobreaksecfalse
\DeclareOptionX{autobreaksec}{\@autobreaksectrue}

\DeclareOptionX*{\PackageWarning{pethesis}{`\CurrentOption' is ignored}}
\ExecuteOptionsX{jpfont=ipa}
\ProcessOptionsX\relax

\ifluatex
\else
  \ifxetex
  \else
    \PackageError{pethesis}{Only XeTeX and LuaTeX are supported.}
  \fi
\fi

% ------------------------------------------------------------------------------
% 必要なパッケージ
% ------------------------------------------------------------------------------
\RequirePackage[utf8]{inputenc}
\RequirePackage{indentfirst}
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsthm}
\RequirePackage[pagestyles]{titlesec}
\RequirePackage{fancyhdr}
\RequirePackage{fancybox}
\RequirePackage{emptypage}
\RequirePackage{xspace}
\RequirePackage{charter}
\RequirePackage[title]{appendix}

\ifpdftex
  \RequirePackage[pdftex]{graphicx}
\fi

\ifluatex
  \RequirePackage[luatex]{graphicx}
\fi

\ifxetex
  \RequirePackage[xetex]{graphicx}
\fi

% ------------------------------------------------------------------------------
% フォントの設定
% ------------------------------------------------------------------------------

\ifluatex
  \RequirePackage{luatexja}
  \RequirePackage[match]{luatexja-fontspec}
  \ifthenelse{\equal{\@jpfont}{noto}}{
    \setmainfont[
      Extension={.otf},
      Path={fonts/NotoSerifJP/},
      UprightFont={*-Regular},
      BoldFont={*-Bold}
    ]{NotoSerifJP}
    \setsansfont[
      Extension={.otf},
      Path={fonts/NotoSansJP/},
      UprightFont={*-Regular},
      BoldFont={*-Bold}
    ]{NotoSansJP}
    \setmainjfont[
      Extension={.otf},
      Path={fonts/NotoSerifJP/},
      UprightFont={*-Regular},
      BoldFont={*-Bold}
    ]{NotoSerifJP}
    \setsansjfont[
      Extension={.otf},
      Path={fonts/NotoSansJP/},
      UprightFont={*-Regular},
      BoldFont={*-Bold}
    ]{NotoSansJP}
  }{
    \ifthenelse{\equal{\@jpfont}{ipa}}{
      \setsansfont[
        Extension={.ttf},
        Path={fonts/IPA/},
        BoldFont={*-bold},
        ItalicFont={*-italic}
      ]{ipagp}
      \setmainfont[
        Extension={.ttf},
        Path={fonts/IPA/},
        BoldFont={*-bold},
        ItalicFont={*-italic}
      ]{ipamp}
      \setsansjfont[
        Extension={.ttf},
        Path={fonts/IPA/},
        BoldFont={*-bold},
        ItalicFont={*-italic}
      ]{ipaexg}
      \setmainjfont[
        Extension={.ttf},
        Path={fonts/IPA/},
        BoldFont={*-bold},
        ItalicFont={*-italic}
      ]{ipaexm}
    }{
      \DeclareOption*{
        \PackageWarning{pethesis}{Unknown JP font '\CurrentOption' is specified!}
      }
    }
  }
\fi

\ifxetex
  \RequirePackage{fontspec}
  \RequirePackage{zxjatype} % For printing Japanese. Requires fontspec.
  \ifthenelse{\equal{\@jpfont}{noto}}{
    \setmainfont[
      Extension={.otf},
      Path={fonts/NotoSerifJP/},
      UprightFont={*-Regular},
      BoldFont={*-Bold}
    ]{NotoSerifJP}
    \setsansfont[
      Extension={.otf},
      Path={fonts/NotoSansJP/},
      UprightFont={*-Regular},
      BoldFont={*-Bold}
    ]{NotoSansJP}
    \setjamainfont[
      Extension={.otf},
      Path={fonts/NotoSerifJP/},
      UprightFont={*-Regular},
      BoldFont={*-Bold}
    ]{NotoSerifJP}
    \setjasansfont[
      Extension={.otf},
      Path={fonts/NotoSansJP/},
      UprightFont={*-Regular},
      BoldFont={*-Bold}
    ]{NotoSansJP}
  }{
    \ifthenelse{\equal{\@jpfont}{ipa}}{
      \setsansfont[
        Extension={.ttf},
        Path={fonts/IPA/},
        BoldFont={*-bold},
        ItalicFont={*-italic}
      ]{ipagp}
      \setmainfont[
        Extension={.ttf},
        Path={fonts/IPA/},
        BoldFont={*-bold},
        ItalicFont={*-italic}
      ]{ipamp}
      \setjasansfont[
        Extension={.ttf},
        Path={fonts/IPA/},
        BoldFont={*-bold},
        ItalicFont={*-italic}
      ]{ipaexg}
      \setjamainfont[
        Extension={.ttf},
        Path={fonts/IPA/},
        BoldFont={*-bold},
        ItalicFont={*-italic}
      ]{ipaexm}
    }{
      \DeclareOption*{
        \PackageWarning{pethesis}{Unknown JP font '\CurrentOption' is specified!}
      }
    }
  }
\fi  % \ifxetex

% ------------------------------------------------------------------------------
% 数式フォントの設定
% ------------------------------------------------------------------------------
\RequirePackage[math-style=ISO]{unicode-math}
\unimathsetup{math-style=TeX,bold-style=TeX}
\setmainfont[
  Path={fonts/STIX2/},
  Extension={.otf},
  UprightFont={*-Regular},
  BoldFont={*-Bold},
  ItalicFont={*-Italic},
  BoldItalicFont={*-BoldItalic},
  Scale=1.05
]{STIXTwoText}

\setmathfont[
  Path={fonts/STIX2/},
  Extension={.otf},
  Scale=1.05
]{STIXTwoMath-Regular}

\AtBeginDocument{\renewcommand{\mathbf}[1]{\symbf{#1}}}
\AtBeginDocument{\renewcommand{\mathrm}[1]{\symrm{#1}}}
\AtBeginDocument{\renewcommand{\mathit}[1]{\symit{#1}}}
\AtBeginDocument{\newcommand{\bm}[1]{\symbfit{#1}}}

% ------------------------------------------------------------------------------
% 句読点の自動置換
% ------------------------------------------------------------------------------
\RequirePackage{newunicodechar}
\newunicodechar{。}{．}
\newunicodechar{、}{，}
\newunicodechar{⭕}{\raisebox{.2ex}{$\bigcirc$}}
\newunicodechar{○}{\raisebox{.2ex}{$\bigcirc$}}
\newunicodechar{◯}{\raisebox{.2ex}{$\bigcirc$}}
\newunicodechar{☓}{$\times$}

% ------------------------------------------------------------------------------
% SI単位系の表示を調整
% ------------------------------------------------------------------------------
\RequirePackage{siunitx}
\sisetup{
  group-separator={,},
}

% ------------------------------------------------------------------------------
% ページの設定
% ------------------------------------------------------------------------------
% 1inch = 25.4 mm
% A4 210mm×297mm
\RequirePackage{geometry}
\geometry{
  textwidth=160mm,
  textheight=234mm,
  left=25mm
}

% ページのコンテンツを上に詰める
\raggedbottom

%\hoffset=0truemm
%\voffset=0truemm
%\setlength{\textwidth}{41zw}
%\setlength{\textheight}{34\baselineskip}
%\textwidth=160truemm %本文領域の高さ（縦幅）
%\textheight=234truemm % 本文領域の横幅
%\oddsidemargin=0truemm%ページ左端のマージン。奇数・偶数ページのデザインは同じとする
%\evensidemargin=0truemm
%\topmargin=-11truemm%ヘッダー上のマージン
%\headsep=12truemm%ヘッダー下端と本文領域との間の幅

% ------------------------------------------------------------------------------
% 各種サイズ
% ------------------------------------------------------------------------------
\setlength{\parindent}{4mm}
\renewcommand{\baselinestretch}{1.2}

% ------------------------------------------------------------------------------
% 章，節などの設定
% ------------------------------------------------------------------------------
\titleformat{\chapter}[display]{\normalfont\LARGE\sffamily\bfseries}{第 \thechapter 章}{0pt}{}
\titleformat{\section}{\normalfont\Large\sffamily\bfseries}{\thesection}{12pt}{}
\titleformat{\subsection}{\normalfont\large\sffamily}{\thesubsection}{12pt}{}

\renewcommand{\thesection}{\arabic{chapter}.\,\arabic{section}}
\renewcommand{\thesubsection}{\arabic{chapter}.\,\arabic{section}.\,\arabic{subsection}}

% 各節の前で改ページする (最初の節だけは自動で改ページしない)
\if@autobreaksec
  \let\oldsection\section
  \renewcommand{\section}{
    \ifnum\c@section>0
      \clearpage
    \else
    \fi
    \oldsection
  }
\fi

% ------------------------------------------------------------------------------
% 日本語表記
% ------------------------------------------------------------------------------
\renewcommand{\figurename}{図}
\renewcommand{\tablename}{表}
\renewcommand{\contentsname}{目次}
\renewcommand{\listfigurename}{図目次}
\renewcommand{\listtablename}{表目次}
\renewcommand{\bibname}{参考文献}
\renewcommand{\appendixtocname}{付録}

% ------------------------------------------------------------------------------
% 表紙の設定
% ------------------------------------------------------------------------------

% 表紙用の新変数
\def\thesistype#1{\gdef\@thesistype{#1}}
\def\title#1{\gdef\@title{#1}}
\def\etitle#1{\gdef\@etitle{#1}}
\def\studentid#1{\gdef\@studentid{#1}}
\def\author#1{\gdef\@author{#1}}
\def\supervisor#1{\gdef\@supervisor{#1}}
\def\affiliation#1{\gdef\@affiliation{#1}}
\def\adjustspace#1{\gdef\@adjustspace{#1}}

% 表紙に使うレイアウトの定義
\def\triplebox{\VerbBox\@triplebox}
\def\@triplebox#1{%
  \begingroup
    \setbox\@fancybox\hbox{{#1}}%
    \fboxrule=.75\fboxrule
    \setbox\@fancybox\hbox{\fbox{\box\@fancybox}}%
    \fboxrule=2\fboxrule
    \fboxsep=\fboxrule
    \advance\fboxsep .5pt
    \fbox{\setlength{\fboxrule}{.9mm}\fbox{\box\@fancybox}}
  \endgroup}

% 表紙コマンドの定義
\renewcommand\maketitle{
	\thispagestyle{empty}
    \fancypage{\triplebox}
    {}

    \begin{center}
      \vspace*{8truemm}
      {\bfseries\sffamily \@thesistype}\\
      \vspace*{5truemm}
      \includegraphics[width=48truemm]{utlogo.pdf}\\
      \vspace*{20truemm}
              {\bfseries\sffamily\fontsize{22truept}{22truept}\selectfont\@title\\[-\baselineskip]~} \\
      \vspace*{12truemm}
              {\rmfamily\fontsize{18truept}{18truept}\selectfont\@etitle\\[-\baselineskip]~} \\
      \vspace*{\@adjustspace}
        {\fontsize{18truept}{18truept}\selectfont 指導教員 \quad \@supervisor}\\
        \vspace*{17truemm}
        \fontsize{16truept}{16truept}\selectfont
        \@affiliation\\
      \vspace*{2truemm}
        {\fontsize{16truept}{16truept}\selectfont 学生証番号\@studentid} \\
      \vspace*{9truemm}
      \vspace*{7truemm}{\fontsize{20truept}{20pt}\selectfont	\@author}
      \vfill
    \end{center}

	\newpage
	\fancypage{}{}
	\cleardoublepage
}

% ------------------------------------------------------------------------------
% 目次の設定
% ------------------------------------------------------------------------------

% 番号とタイトルの間のスペースを調整
\RequirePackage{tocloft}
\setlength{\cftfignumwidth}{3em}
\setlength{\cfttabnumwidth}{3em}

% 目次のフォントを設定
\renewcommand{\cfttoctitlefont}{\LARGE\bfseries\sffamily}
\renewcommand{\cftloftitlefont}{\LARGE\bfseries\sffamily}
\renewcommand{\cftlottitlefont}{\LARGE\bfseries\sffamily}
\renewcommand{\cftchapfont}{\sffamily\large}
\renewcommand{\cftsecfont}{\normalsize}
\renewcommand{\cftsubsecfont}{\normalsize}

% 章の項目もドットでページ番号までを繋ぐ
%\renewcommand{\cftchapleader}{\cftdotfill{\cftchapdotsep}}
%\renewcommand{\cftchapdotsep}{\cftdotsep}
\renewcommand{\cftdotsep}{0.5}

% ------------------------------------------------------------------------------
% 論文全体の概要
% ------------------------------------------------------------------------------
\makeatletter
\newenvironment{abstract}{%
  \thispagestyle{empty}
  \vspace*{40truemm}
  \begin{center}
    {\bfseries\sffamily {\fontsize{18truept}{18pt}}\selectfont 概要}
  \end{center}
  \edef\currentindent{\the\parindent}
  \begin{minipage}{\textwidth}\setlength{\parindent}{\currentindent}}
  {\end{minipage}\clearpage}
\makeatother

% ------------------------------------------------------------------------------
% 各章の概要
% ------------------------------------------------------------------------------

\def\textitjp#1{
  \makebox[2.25zw][l]{
    \vphantom{#1}\rotatebox{-48.8}{
      \scalebox{0.875}[1.143]{
        \rotatebox{41.2}{
          \smash{\rlap{#1}}
        }
      }
    }
  }
}

\makeatletter
\newlength\chapabstbelowskip
\setlength{\chapabstbelowskip}{5mm}
\newenvironment{chapabst}
  {\setlength{\rightskip}{1in}\begin{small}\noindent\textbf{\textsf{本章の概要:}}~}
  {\end{small}\vspace{\chapabstbelowskip}}
\makeatother


% ------------------------------------------------------------------------------
% ページヘッダの制御
% ------------------------------------------------------------------------------

% ヘッダの下の横線
\pagestyle{fancyplain}

% ヘッダの内容
\fancyhead{}
\fancyhead[RO,RE]{\rightmark}
\fancyhead[LE,LO]{\leftmark}
\fancyhead[RE]{\gdef\headrulewidth{.4pt}}
\fancyhead[LO]{\gdef\headrulewidth{.4pt}}
\fancyfoot[C]{\thepage}

%ヘッダ記述。 ~ で章・節番号とそのタイトルの間のスペースを調整
\renewcommand{\chaptermark}[1]{\markboth{第 \thechapter 章~~~#1}{}}

%ヘッダ記述。 ~ で章・節番号とそのタイトルの間のスペースを調
\renewcommand{\sectionmark}[1]{\markright{\thesection ~~~#1}{}}

% plainスタイルを再定義してheaderが章の最初の出ないようにする
% https://tex.stackexchange.com/questions/117328/fancyhdr-does-not-apply-same-header-footer-on-chapter-and-non-chapter-pages
\fancypagestyle{plain}{%
  \fancyhead{}%
  \renewcommand{\headrulewidth}{0pt}% Line at the header invisible
}

% ------------------------------------------------------------------------------
% 参考文献が目次に乗るようにする。
% http://www.nsknet.or.jp/~tony/TeX/faq/macro.htm
% ------------------------------------------------------------------------------

\makeatletter
\renewenvironment{thebibliography}[1]% 再定義
{\chapter*{\bibname\@mkboth{\bibname}{\bibname}}%
  \addcontentsline{toc}{chapter}{\bibname}% この行追加
  \list{\@biblabel{\@arabic\c@enumiv}}%
    {\settowidth\labelwidth{\@biblabel{#1}}%
      \leftmargin\labelwidth
      \advance\leftmargin\labelsep
      \@openbib@code
      \usecounter{enumiv}%
      \let\p@enumiv\@empty
      \renewcommand\theenumiv{\@arabic\c@enumiv}}%
  \sloppy
  \clubpenalty4000
  \@clubpenalty\clubpenalty
  \widowpenalty4000%
  \sfcode`\.\@m}
  {\def\@noitemerr
    {\@latex@warning{Empty `thebibliography' environment}}%
    \endlist}
\makeatother

% ------------------------------------------------------------------------------
%謝辞
% ------------------------------------------------------------------------------
\makeatletter
\newenvironment{acknowledgement}{%
  \renewcommand{\chaptermark}[1]{
    \markboth{謝辞}{}
  }
  \chapter*{謝辞}\addcontentsline{toc}{chapter}{謝辞}}
  {}
\makeatother

%
% 章番号とタイトルに改行を入れない
%http://anchoret.seesaa.net/article/82436197.html
%
% \makeatletter
% \def\@makechapterhead#1{%
%   \vspace*{2\Cvs}
%   {\parindent \z@ \raggedright \normalfont
%   \Huge\headfont
%   \ifnum \c@secnumdepth >\m@ne
%     \if@mainmatter
%       \@chapapp\thechapter\@chappos
%       \hskip10mm
%     \fi
%   \fi
%   #1\par\nobreak
%   \vskip 3\Cvs}
% }
% \makeatother

% ------------------------------------------------------------------------------
% 目次の設定
% ------------------------------------------------------------------------------
% 目次に乗せる項目を\subsection まで索引を作成する。
\setcounter{tocdepth}{2}

% 目次にhyperrefで色がつくのを避ける
%\let\oldtableofcontents\tableofcontents
%\renewcommand{\tableofcontents}{{\hypersetup{hidelinks}\oldtableofcontents}}

% ------------------------------------------------------------------------------
% 付録の設定
% ------------------------------------------------------------------------------

\let\oldappendices\appendices
\let\endoldappendices\endappendices
\renewenvironment{appendices}{
  \begin{oldappendices}
  \noappendicestocpagenum
  \addappheadtotoc
  \renewcommand{\thechapter}{\Alph{chapter}}
  \titleformat{\chapter}[display]{\LARGE\bfseries\sffamily}{付録 \thechapter}{0pt}{}
}{\end{oldappendices}}

\makeatletter
\renewcommand{\@redotocentry@pp}[1]{%
  \let\oldacl@pp=\addcontentsline
  \def\addcontentsline##1##2##3{%
    \def\@pptempa{##1}\def\@pptempb{toc}%
    \ifx\@pptempa\@pptempb
      \def\@pptempa{##2}\def\@pptempb{#1}%
      \ifx\@pptempa\@pptempb
        \oldacl@pp{##1}{##2}{付録\space ##3}%
      \else
        \oldacl@pp{##1}{##2}{\chaptertitlename\space ##3}% added \chaptertitlename
      \fi
    \else
      \oldacl@pp{##1}{##2}{##3}%
    \fi
  }
}
\makeatother

% ------------------------------------------------------------------------------
% 数式前後のマージンの設定
% ------------------------------------------------------------------------------
\AtBeginDocument{\setlength{\abovedisplayskip}{8mm}}
\AtBeginDocument{\setlength{\abovedisplayshortskip}{8mm}}
\AtBeginDocument{\setlength{\belowdisplayskip}{8mm}}
\AtBeginDocument{\setlength{\belowdisplayshortskip}{8mm}}
\newcommand{\adjustdisplayskips}[1]{%
  \setlength{\abovedisplayskip}{#1}
  \setlength{\abovedisplayshortskip}{#1}
  \setlength{\belowdisplayskip}{#1}
  \setlength{\belowdisplayshortskip}{#1}
}

% ------------------------------------------------------------------------------
% 箇条書きの設定
% ------------------------------------------------------------------------------
\RequirePackage{enumitem}
\setlist{
  itemsep=1pt,
  parsep=0pt,
  labelsep=3mm
}

\setlist[itemize]{
  label=$\vcenter{\hbox{$\bullet$}}$,
}

\setlist[enumerate]{
  label={\bfseries\sffamily\arabic*.}
}

% ------------------------------------------------------------------------------
% 図表の設定
% ------------------------------------------------------------------------------
\RequirePackage{caption}
\captionsetup[figure]{format=plain, labelformat=simple, labelsep=quad, labelfont={bf,sf}, font=small}
\captionsetup[table]{format=plain, labelformat=simple, labelsep=quad, labelfont={bf,sf}, font=small}
\captionsetup[lstlisting]{format=plain, labelformat=simple, labelsep=quad, labelfont={bf,sf}, font=small}


% ------------------------------------------------------------------------------
% ソースコードの設定
% ------------------------------------------------------------------------------
\RequirePackage{listings}
\RequirePackage{jvlisting}
\renewcommand{\lstlistingname}{リスト}
\lstset{
  basicstyle=\ttfamily\footnotesize,
  commentstyle=\textit,
  classoffset=1,
  keywordstyle=\bfseries,
  frame=trbl,
  framesep=5pt,
  xrightmargin=0pt,
  xleftmargin=5pt,
  showstringspaces=false,
  columns=[l]{fullflexible},
  stepnumber=1,
  numberstyle=\footnotesize,
  tabsize=2,
  breaklines=true,
}

% ------------------------------------------------------------------------------
% 枠付き段落
% ------------------------------------------------------------------------------
\RequirePackage{color}
\RequirePackage{mdframed}
\newenvironment{titlebox}[1]
  {\mdfsetup{
    frametitle={\colorbox{white}{\space#1\space}},
    innertopmargin=0,
    frametitleaboveskip=-.8\ht\strutbox,
    frametitlealignment=\raggedright
    }
  \begin{mdframed}%
  }
  {\end{mdframed}}


% ------------------------------------------------------------------------------
% LaTeXロゴ
% ------------------------------------------------------------------------------
\RequirePackage{xltxtra}
\newcommand{\tex}{\TeX\xspace}
\newcommand{\latex}{\LaTeX\xspace}

\newcommand{\BibTeX}{
  \textrm{B\kern-0.1em{\fontsize{1.5ex}{1.5ex}\selectfont I}\kern-0.017em{\fontsize{1.5ex}{1.5ex}\selectfont B}}\kern-0.15em\TeX}
\newcommand{\bibtex}{\BibTeX\xspace}
\newcommand{\BibLaTeX}{
  \textrm{B\kern-0.1em{\fontsize{1.5ex}{1.5ex}\selectfont I}\kern-0.017em{\fontsize{1.5ex}{1.5ex}\selectfont B}}\kern-0.15em\LaTeX}
\newcommand{\biblatex}{\BibLaTeX\xspace}

\newcommand{\PDFLaTeX}{
  \textrm{P\kern-0.1em{\fontsize{1.5ex}{1.5ex}\selectfont D}\kern-0.01em{\fontsize{1.5ex}{1.5ex}\selectfont F}}\kern-0.15em\LaTeX}
\newcommand{\pdflatex}{\PDFLaTeX\xspace}
\newcommand{\lualatex}{\LuaLaTeX\xspace}
\newcommand{\xelatex}{\XeLaTeX\xspace}
